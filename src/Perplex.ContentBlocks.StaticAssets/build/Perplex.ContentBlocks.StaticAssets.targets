<Project>

  <PropertyGroup>
    <ResolveStaticWebAssetsInputsDependsOn>PerplexContentBlocks_StaticAssets/IncludeAppPlugins;$(ResolveStaticWebAssetsInputsDependsOn)</ResolveStaticWebAssetsInputsDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <_Perplex_ContentBlocks_StaticAssets_AppPluginsPrefix>src\</_Perplex_ContentBlocks_StaticAssets_AppPluginsPrefix>
    <_Perplex_ContentBlocks_StaticAssets_AppPluginsDir>$(MSBuildProjectDirectory)\$(_Perplex_ContentBlocks_StaticAssets_AppPluginsPrefix)App_Plugins\Perplex.ContentBlocks</_Perplex_ContentBlocks_StaticAssets_AppPluginsDir>
  </PropertyGroup>

  <Target Name="PerplexContentBlocks_StaticAssets/BeforeBuild" BeforeTargets="BeforeBuild">
    <CallTarget Targets="PerplexContentBlocks_StaticAssets/Build" Condition="'$(Configuration)' == 'Release'" />
  </Target>

  <Target Name="PerplexContentBlocks_StaticAssets/Build">
    <Message Importance="High" Text="Perplex.ContentBlocks: Build Static Assets" />
    <Exec Command="npm install" WorkingDirectory="$(_Perplex_ContentBlocks_StaticAssets_AppPluginsDir)" />
    <Exec Command="npm run build" WorkingDirectory="$(_Perplex_ContentBlocks_StaticAssets_AppPluginsDir)" />
  </Target>

  <Target Name="PerplexContentBlocks_StaticAssets/IncludeAppPlugins">
    <ItemGroup>
      <_AppPluginsFiles Include="$(_Perplex_ContentBlocks_StaticAssets_AppPluginsDir)\umbraco-package.json"></_AppPluginsFiles>
      <_AppPluginsFiles Include="$(_Perplex_ContentBlocks_StaticAssets_AppPluginsDir)\dist\**"></_AppPluginsFiles>
    </ItemGroup>

    <DiscoverStaticWebAssets Candidates="@(_AppPluginsFiles)"
      SourceId="$(PackageId)"
      Pattern="$(_Perplex_ContentBlocks_StaticAssets_AppPluginsPrefix)**"
      ContentRoot="$(MSBuildProjectDirectory)"
      BasePath="$(StaticWebAssetBasePath)">
      <Output TaskParameter="DiscoveredStaticWebAssets" ItemName="_DiscoveredAssets" />
    </DiscoverStaticWebAssets>

    <ItemGroup>
      <StaticWebAsset Remove="@(_DiscoveredAssets)" />
      <StaticWebAsset Include="@(_DiscoveredAssets)" />
    </ItemGroup>

  </Target>

</Project>
